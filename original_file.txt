"use client";

import {
  Modal, 
  Button,
  Form,
  Select,
  Textarea,
  CircularProgress
} from "@/components/ui";

import { Planning, PlanningPost } from "@/types/planning.type";
import { useState } from "react";
 

import Image from "next/image";
import DragDrop from "../icons/DragDrop";
import { BsPlus } from "react-icons/bs";
import Close from "@/layouts/default/components/ui/icons/Close";
import Instagram from "../icons/Instagram";
import Facebook from "../icons/Facebook";
import Tiktok from "../icons/Tiktok";
import { convertFileToBase64 } from "@/utils/base64";
import Trash from "../icons/Trash";
import useProjectStore from "@/store/projectStore";
import DatePicker from "@/components/ui/form/input/NewDateTimePicker";
import MediaPreviewLocalModal from "./MediaPreviewLocal";
import { createReservePostService, ReservePostCreateRequest } from "@/services/client/reserve.service";
import usePlanningStore from "@/store/planningStore";
import useGeneralStore from "@/store/generalStore";

interface Props {
  planning: Planning;
  post: PlanningPost;
  // planningId: number
}

interface PlatformSchedule {
  id: number;
  platform: number | null;
  scheduled_date: string | null;
  content_type: string | null;
}

interface Media {
  id: number;
  file: string;
  object: File | null;
  type: "Video" | "Image"
}

const CreateReservePostModal: React.FC<Props> = ({ planning, post }) => {
  const [isOpen, setIsOpen] = useState(false);
  const onOpen = () => setIsOpen(true);
  const onOpenChange = () => setIsOpen(!isOpen);

  const { fetchPlannings } = usePlanningStore();
  const { setIsLoading } = useGeneralStore();

  const [medias, setMedias] = useState<Media[]>([]);
  const [draggedItemId, setDraggedItemId] = useState<number | null>(null);

  const [content, setContent] = useState<string>("");

  const { socialMedias, socialMediaContentTypes } = useProjectStore();

  const [platformSchedules, setPlatformSchedules] = useState<
    PlatformSchedule[]
  >([
    {
      id: 1,
      platform: null,
      scheduled_date: null,
      content_type: null,
    },
  ]);

  const handleAddNewPladformSchedules = () => {
    setPlatformSchedules(() => [
      ...platformSchedules,
      {
        id: platformSchedules[platformSchedules.length - 1].id + 1,
        platform: null,
        scheduled_date: null,
        content_type: null,
      },
    ]);
  };

  const handleDeletePlatformSchedule = (id: number) => {
    setPlatformSchedules((prevSchedules) =>
      prevSchedules.filter((schedule) => schedule.id !== id)
    );
  };

  const handleUpdatePlatformInSchedule = (
    id: number,
    newPlatform: number | null
  ) => {
    setPlatformSchedules((prevSchedules) =>
      prevSchedules.map((schedule) =>
        schedule.id === id ? { ...schedule, platform: newPlatform } : schedule
      )
    );
  };

  const handleUpdateContentTypeInSchedule = (
    id: number,
    newContentType: string | null
  ) => {
    setPlatformSchedules((prevSchedules) =>
      prevSchedules.map((schedule) =>
        schedule.id === id
          ? { ...schedule, content_type: newContentType }
          : schedule
      )
    );
  };

  const handleUpdateScheduledDateInSchedule = (
    id: number,
    newScheduledDate: string | null
  ) => {
    setPlatformSchedules((prevSchedules) =>
      prevSchedules.map((schedule) =>
        schedule.id === id
          ? { ...schedule, scheduled_date: newScheduledDate }
          : schedule
      )
    );
  };

  const handleSumbit = async () => {
    setIsLoading(true);
    const mediaList = await Promise.all(
      medias.map(async (media) => {
          if (media.object?.name) {
              const base64File = await convertFileToBase64(media.object);
              return base64File;
          }
          return null;
      })
  );
    const data: ReservePostCreateRequest = {
      planning_post: post.id,
      content: content,
      medias: mediaList.filter((media) => media !== null) as string[],
      platform_schedules: platformSchedules.map((schedule) => ({
        scheduled_date: schedule.scheduled_date || "",
        content_type: schedule.content_type || "",
        platform: schedule.platform || 0,
      })),
    };
    try{
      await createReservePostService(data)
      fetchPlannings();
      onOpenChange()
    }catch(error){
      console.log(error);
    }
    setIsLoading(false);
  };

  const handleDragStart = (id: number): void => {
    setDraggedItemId(id);
  };

  // Default davranışı engelle (drop'un çalışması için)
  const handleDragOver = (e: React.DragEvent<HTMLDivElement>): void => {
    e.preventDefault();
  };

  // Öğeyi yeni yerine taşı
  const handleDrop = (targetId: number): void => {
    if (!draggedItemId || draggedItemId === targetId) return;

    const updatedItems = [...medias];
    const draggedIndex = updatedItems.findIndex(
      (item) => item.id === draggedItemId
    );
    const targetIndex = updatedItems.findIndex((item) => item.id === targetId);

    // Sürüklenen öğeyi kaldır
    const [removedItem] = updatedItems.splice(draggedIndex, 1);

    // Yeni yerine ekle
    updatedItems.splice(targetIndex, 0, removedItem);

    setMedias(updatedItems); // Listeyi güncelle
    setDraggedItemId(null); // Sürükleme durumunu sıfırla
  };

  

  const handleDeleteMedia = async (id: number) => {
      setMedias((prev) => prev.filter((media) => media.id !== id));
      console.log(medias)
  };

  
  const handleMediaChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    // Dosya için benzersiz bir ID oluştur
    const mediaId = Date.now();

    // Dosya türünü kontrol et
    const fileType = file.type.startsWith("video") ? "Video" : "Image";

    // Dosyayı base64'e dönüştür
    const reader = new FileReader();
    reader.onload = (event) => {
      if (event.target && event.target.result) {
        // Yeni medya öğesini ekle
        setMedias((prevMedias) => [
          ...prevMedias,
          {
            id: mediaId,
            file: event.target?.result as string,
            object: file,
            type: fileType,
          },
        ]);
      }
    };
    reader.readAsDataURL(file);
  };

  return (
    <>
      <Button
        variant="link"
        className="text-primary p-0 m-0 min-w-0"
        onClick={onOpen}
      >
        Rezerv əlavə et
      </Button>
      <Modal isOpen={isOpen} onClose={onOpenChange}>
        <Modal.Header className="font-medium text-t-black text-2xl">
          Rezerv
        </Modal.Header>
        <Modal.Body className="min-h-[500px] overflow-y-auto max-h-[700px]">
          <div className="flex items-center gap-4">
            <div>
              <span className="text-t-gray">Planlama:</span>
              <span className="text-t-black font-medium pl-2">
                {planning.project.title}
              </span>
            </div>
            <div>
              <span className="text-t-gray">Post:</span>
              <span className="text-t-black font-medium pl-2">
                {post.content}
              </span>
            </div>
          </div>
          <div>
            <h3 className="text-xl font-medium">Sosial şəbəkələr</h3>
            <div>
              {planning.platforms.map((item, index) => (
                <div
                  key={index}
                  className="flex items-center gap-3 mt-3"
                >
                  <div>
                    {item.title === "instagram" && <Instagram />}
                    {item.title === "facebook" && <Facebook />}
                    {item.title === "tiktok" && <Tiktok />}
                  </div>
                  <a target="_blank" href={item.link} rel="noopener noreferrer">
                    {item.link}
                  </a>
                </div>
              ))}
            </div>
          </div>
          <div className="mt-4">
            <div className="flex justify-between items-center">
              <label className="text-t-black font-medium">Məzmun</label>
            </div>

            <Textarea
              onChange={(e) => setContent(e.target.value)}
              value={content}
              className="mt-2 w-full h-[200px]"
            />
          </div>

          <div>
            <h3 className="text-xl font-medium mt-4 text-t-black">
              Platformalar
            </h3>
            <div className="mt-4 border-t border-[#A4A9FF] pt-4">
              <table className="table-auto w-full">
                <thead>
                  <tr>
                    <td className="px-2 py-1 font-semibold text-t-black">
                      Platforma
                    </td>
                    <td className="px-2 py-1 font-semibold text-t-black">
                      Harada paylaşılacaq
                    </td>
                    <td className="px-2 py-1 font-semibold text-t-black">
                      Planlanılan tarix
                    </td>
                    <td className="px-2 py-1 font-semibold text-t-black">
                      Sil
                    </td>
                  </tr>
                </thead>
                <tbody>
                  {platformSchedules.map((schedule, index) => (
                    <tr key={index}>
                      <td className="px-2 py-1">
                        <Select
                          placeholder="Seçin"
                          aria-label="Statuslar"
                          className="bg-white max-w-[250px]"
                          onChange={(value: string) => {
                            handleUpdatePlatformInSchedule(
                              schedule.id,
                              Number(value)
                            );
                          }}
                        >
                          {socialMedias.map((item) => (
                            <Select.Option key={item.id} value={item.id.toString()}>
                              {item.name_display}
                            </Select.Option>
                          ))}
                        </Select>
                      </td>
                      <td className="px-2 py-1">
                        <Select
                          placeholder="Seçin"
                          aria-label="Statuslar"
                          className="bg-white capitalize"
                          onChange={(value: string) => {
                            handleUpdateContentTypeInSchedule(
                              schedule.id,
                              value
                            );
                          }}
                        >
                          {socialMediaContentTypes
                            .filter(
                              (item) =>
                                item.platform ===
                                socialMedias.find(
                                  (media) => media.id === schedule.platform
                                )?.name
                            )[0]
                            ?.content_types.map((item) => (
                              <Select.Option key={item} value={item}>
                                <span className="capitalize">{item}</span>
                              </Select.Option>
                            ))}
                        </Select>
                      </td>
                      <td className="px-2 py-1">
                        <DatePicker
                          id={`reserve_post_${schedule.id}`}
                          value={schedule.scheduled_date|| ""}
                          onChange={(date) =>
                            handleUpdateScheduledDateInSchedule(schedule.id, date)
                          }
                        />
                      </td>
                      
                      <td className="px-2 py-1">
                        <button
                          onClick={() =>
                            handleDeletePlatformSchedule(schedule.id)
                          }
                          className="text-red-500 hover:text-red-700"
                        >
                          <Trash />
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <button
                className="mt-4 text-primary"
                onClick={handleAddNewPladformSchedules}
              >
                + Yeni platforma
              </button>
            </div>
          </div>
          <div className="mt-4">
            <h3 className="text-xl font-medium text-t-black">Medialar</h3>
            <div className="mt-4 border-t border-[#A4A9FF] pt-4 flex flex-wrap items-center gap-2 overflow-x-auto">
              {medias.map((item) => (
                <div
                  key={item.id}
                  draggable
                  onDragStart={() => handleDragStart(item.id)}
                  onDragOver={handleDragOver}
                  onDrop={() => handleDrop(item.id)}
                >
                  <div className="w-[150px] h-[150px] relative group rounded-[10px] overflow-hidden shadow-sm">
                    {item.type === "Video" ? (
                      <video className="absolute left-0 top-0 w-full h-full object-cover ">
                        <source src={item.file} type="video/mp4" />
                      </video>
                    ) : (
                      <Image
                        className="absolute left-0 top-0 w-full h-full object-cover "
                        src={item.file}
                        width={1000}
                        height={1000}
                        alt="media"
                      />
                    )}
                    <div className="absolute z-40 bottom-[5px] hover:cursor-grab left-[5px] hidden group-hover:grid bg-black w-[30px] h-[30px] rounded-full place-items-center">
                      <DragDrop />
                    </div>
                    <button
                      onClick={() => handleDeleteMedia(item.id)}
                      className="absolute z-40 top-[5px] hover:cursor-grab right-[5px] hidden group-hover:grid bg-black w-[30px] h-[30px] rounded-full place-items-center"
                    >
                      <Close stroke="red" size={22} />
                    </button>
                    <div className="absolute place-items-center w-full h-full hidden group-hover:grid">
                      <MediaPreviewLocalModal media={item} />
                    </div>
                  </div>
                </div>
              ))}
              <div className="w-[150px] relative cursor-pointer hover:bg-slate-100 h-[150px] border-dashed border-2 border-border-gray rounded-[10px] grid place-items-center">
                <div className="w-[60px] h-[60px] border-2 text-t-gray border-border-gray rounded-full grid place-items-center">
                  <BsPlus size={48} />
                </div>
                <input
                  type="file"
                  accept="image/*,video/*"
                  className="absolute w-full h-full opacity-0 cursor-pointer"
                  onChange={handleMediaChange}
                />
              </div>
            </div>
          </div>
        </Modal.Body>
        <Modal.Footer className="flex justify-end">
          <Button
            variant="secondary"
            className="font-medium text-t-black rounded-lg mr-2"
            onClick={onOpenChange}
          >
            Bağla
          </Button>
          <Button
            variant="primary"
            className="font-medium text-white px-6 rounded-lg"
            onClick={handleSumbit}
          >
            Təsdiqlə
          </Button>
        </Modal.Footer>
      </Modal>
    </>
  );
};

export default CreateReservePostModal;
